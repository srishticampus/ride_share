name: Deploy to VPS - MERN Stack

on:
  push:
    branches: [main]

env:
  VPS_IP: ${{ secrets.VPS_IP }}
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
  DEPLOY_DIR: /home/ubuntu/new_hybrid_projects/ride_share
  PM2_APP_NAME: ride_share

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Frontend build (output to root dist)
    - name: Build React frontend
      working-directory: ./client
      run: |
        npm ci
        npm run build -- --outDir=../dist

    # Backend preparation
    - name: Prepare backend
      working-directory: ./server
      run: |
        npm ci --omit=dev

    # Create deployment package with proper .env handling
    - name: Create deployment structure
      run: |
        mkdir -p deploy
        
        # Copy frontend build files directly to deploy root
        cp -r dist/* deploy/
        
        # Create backend directory and copy files
        mkdir -p deploy/backend
        cp -r server/* deploy/backend/
        rm -rf deploy/backend/node_modules
        
        # Create .env file directly in deploy/backend
        echo "NODE_ENV=production" > deploy/backend/.env
        echo "PORT=${{ secrets.PORT }}" >> deploy/backend/.env
        echo "MONGO_URI=${{ secrets.MONGO_URI }}" >> deploy/backend/.env
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> deploy/backend/.env
        echo "JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}" >> deploy/backend/.env
        echo "JWT_COOKIE_EXPIRES_IN=${{ secrets.JWT_COOKIE_EXPIRES_IN }}" >> deploy/backend/.env
        echo "UPLOAD_LIMIT=${{ secrets.UPLOAD_LIMIT }}" >> deploy/backend/.env
        echo "RATE_LIMIT_WINDOW=${{ secrets.RATE_LIMIT_WINDOW }}" >> deploy/backend/.env
        echo "RATE_LIMIT_MAX=${{ secrets.RATE_LIMIT_MAX }}" >> deploy/backend/.env
        echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> deploy/backend/.env
        echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> deploy/backend/.env
        echo "EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}" >> deploy/backend/.env
        echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> deploy/backend/.env
        echo "EMAIL_FROM=${{ secrets.EMAIL_FROM }}" >> deploy/backend/.env

    # Compress for transfer
    - name: Compress deployment package
      run: tar -czvf ride_share.tar.gz -C deploy .

    # Deploy to VPS
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.VPS_SSH_KEY }}
        known_hosts: 'just-a-placeholder-so-we-dont-get-errors'

    - name: Transfer files to VPS
      run: |
        scp -o StrictHostKeyChecking=no ride_share.tar.gz ${{ env.VPS_USER }}@${{ env.VPS_IP }}:/tmp/

    - name: SSH and deploy on VPS
      run: |
        ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_IP }} << EOF
        # Create directory if not exists
        mkdir -p ${{ env.DEPLOY_DIR }}
        
        # Clear existing files (except uploads if needed)
        rm -rf ${{ env.DEPLOY_DIR }}/*
        
        # Extract files
        tar -xzvf /tmp/ride_share.tar.gz -C ${{ env.DEPLOY_DIR }}

        # Ensure uploads directory exists with proper permissions
        mkdir -p ${{ env.DEPLOY_DIR }}/backend/uploads
        chmod -R 755 ${{ env.DEPLOY_DIR }}/backend/uploads

        # Install backend dependencies
        cd ${{ env.DEPLOY_DIR }}/backend
        npm install --omit=dev

        # Restart application with PM2
        pm2 delete ${{ env.PM2_APP_NAME }} || true
        pm2 start server.js --name "${{ env.PM2_APP_NAME }}"
        pm2 save
        EOF